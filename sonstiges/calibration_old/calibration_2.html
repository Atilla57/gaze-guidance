<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGazer Precise Calibration</title>
    <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
</head>
<body>
    <div id="instructions">Click on each red dot to calibrate your gaze.</div>
    <div id="calibration-area"></div>
    <div id="status">Status: WebGazer is not running.</div>

    <script>
        const calibrationArea = document.getElementById('calibration-area');
        const statusDisplay = document.getElementById('status');
        const instructions = document.getElementById('instructions');
        const rows = 6;
        const cols = 6;
        let completedDots = 0;
        const totalDots = rows * cols;
        let calibrationData = [];

        function generateCalibrationDots() {
            const areaWidth = calibrationArea.offsetWidth;
            const areaHeight = calibrationArea.offsetHeight;
            const rowSpacing = areaHeight / (rows + 1);
            const colSpacing = areaWidth / (cols + 1);

            for (let row = 1; row <= rows; row++) {
                for (let col = 1; col <= cols; col++) {
                    const dot = document.createElement('div');
                    dot.className = 'calibration-dot';
                    const x = col * colSpacing;
                    const y = row * rowSpacing;
                    dot.style.top = `${y}px`;
                    dot.style.left = `${x}px`;
                    calibrationArea.appendChild(dot);

                    dot.addEventListener('click', () => {
                        onDotClick(dot, x, y);
                    });
                }
            }
        }

        function onDotClick(dot, x, y) {
            setTimeout(() => {
                dot.classList.add('clicked');
                webgazer.addCalibrationPoint(x, y);
                calibrationData.push({ x, y });
                console.log(`Calibration point applied: (${x}, ${y})`);
                completedDots++;

                if (completedDots === totalDots) {
                    instructions.textContent = "Calibration complete!";
                    statusDisplay.textContent = "Status: Calibration applied and complete.";
                    saveCalibrationToFile();
                    restartWebGazer();
                }
            }, 1500);
        }

        function saveCalibrationToFile() {
            const blob = new Blob([JSON.stringify(calibrationData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'calibrationData.json';
            a.click();
            console.log("Calibration data saved to JSON file.");
        }

        function restartWebGazer() {
            webgazer.pause();
            webgazer.begin();
            console.log("WebGazer restarted with updated calibration.");
        }

        window.onload = () => {
            webgazer.setGazeListener((data, elapsedTime) => {
                if (data) {
                    console.log(`Gaze Data: X=${data.x}, Y=${data.y}, Time=${elapsedTime}`);
                }
            }).begin()
            .then(() => {
                console.log("WebGazer has started.");
                statusDisplay.textContent = "Status: WebGazer is running.";
            })
            .catch(err => {
                console.error("Error starting WebGazer:", err);
                statusDisplay.textContent = "Error: Could not start WebGazer.";
            });

            generateCalibrationDots();
        };
    </script>
</body>
</html>
